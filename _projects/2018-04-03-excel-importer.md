---
layout: post
title:  "Загрузчик из Excel в БД"
preview:
date: 2018-04-03
categories: java db data-processing
---
##### Стэк: `Java 6-7` `PostgreSQL` `Apache POI` `Hibernate`

#### Задача

Даны файлы MSExcel, на листах которых есть данные в табличном 
представлении — первая строка с заголовками, под ней строки с информацией, 
которую нужно обработать и занести в базу данных. При этом надо проверить 
данные на корректность, обработать (в частности, для некоторых полей 
заменять значения по словарю).
<!--more-->
#### Решение

Интересный проект, над которым в основном работал с 2011 по 2015 годы. 
Особенно интересный потому, что _схема базы данных периодически менялась_, 
а потом появились шаблоны входных данных, _отличные от простой 
таблицы_.

Многое реализовывал через `Java Reflection API`, придерживаясь стандартной 
конвенции наименования `set-/get-` и вызывая нужные методы по имени. Очень 
облегчило задачу обновления программы при расширении схемы БД. Привязку столбцов 
к переменным осуществлял через xml-файл настроек с возможностью подачи на 
вход файла с названиями переменных в качестве столбцов для автоматической 
привязки.

Логика обработки выносилась в конвертер и специальные типы данных, при этом 
все преобразования из строк идут через _конвертер_ вызовом нужного метода 
_по типу данных_ переменной.

Словари также хранятся в виде xml-файлов, при этом можно использовать два 
типа словарей — _строковые_ и с _регулярными выражениями_. Словари привязываются 
по имени полей, при этом один словарь можно использовать для нескольких 
переменных. 

Также некоторые переменные могут быть _списками_, куда можно заносить данные 
с нескольких ячеек строки. Есть также и _псевдопеременные_: метод `set-` прописан, 
но внутри он разбивает значение по другим переменным. 

Реализована возможность задать имена обязательных полей, при отсутствии 
которых выдавалось предупреждение. В формате этого файла заложена возможность 
перечислений "И" и "ИЛИ".

Реализованы параллельная обработка файлов и пакетное занесение значений в БД.

После обработки файла в интерфейсе отображается результат в виде таблицы 
обработанных данных, при этом выводится подробный список ошибок и создается 
копия исходного файла с раскрашенными по типу ошибок ячейками. 

Данные с файла собираются в список агрегирующих объектов, из которых при занесении 
в базу создаются отображающие ее структуру объекты.

Есть и логирование ошибок программы и работы с базой данных.

#### Дополнения

В базе также хранятся исходные файлы, поэтому в процессе понадобилось реализовать 
инструмент их выгрузки.

Значения, не найденные в словаре, загружались как есть, поэтому понадобилось и 
средство обработки по обновленным словарям данных, _уже имеющихся_ в базе.

